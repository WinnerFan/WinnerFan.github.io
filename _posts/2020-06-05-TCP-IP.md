---
layout: post
title: TCP/IP
tags: Network
---
## 网络基础
### OSI
1. 应用层，与通信无关的。例如标明收件人
2. 表示层，数据表现形式，不同版本会影响。例如编码格式
3. 会话层，采用何种连接方式，何时建立连接，何时发送数据。例如建立5条连接发5封邮件，或者建立1条连接发5封邮件
4. 传输层，建立连接。例如TCP
5. 网络层，网络相互连接中，将数据从发送端发送到接收端
6. 数据链路，在通过传输媒介互联的设备间传输
7. 物理层，转换为01信号，例如MAC地址

### 网络构成要素
1. 网卡
2. 中继器，物理层面上延长网络的设备，调整波形和放大给另一个电缆
3. 网桥/2层交换机，数据链路层面上连接两个网络设备，根据MAC地址处理，识别数据链路层数据帧，临时存储，在重新生成信号作为一个全新的帧发给相连的另一个网段。FCS数据位通过CRC校验，可以丢弃损坏的数据
4. 路由器/3层交换机，网路层面上连接两个网络，对分组报文转发，根据IP地址处理
5. 4-7层交换机，例如负载均衡器，带宽控制，防火墙等
6. 网关，负责将从传输层到应用层的数据进行**转换**和转发，转换体现在互联网邮件和手机邮件兼容，代理服务器客户端和服务器无需在网络层之间通信，而是传输层到应用层对数据和访问控制

## TCP/IP基础

### 分层模型
1. 硬件，物理层，网卡
2. 网络接口层，数据链路层，网卡驱动
3. 互联网层，网络层，主机跟路由器必须实现IP功能。IP分组包不会重发；ICMP为IP数据包中途异常时，给发送端发送一个发生异常的通知
4. 传输层，TCP；UDP
5. 应用层，WWW中的HTTP属于应用层，所传输的数据主要格式HTML属于表示层；E-Mail的MIME扩展了数据格式，属于表示层；FTP将远程文件保存到本地，建立两个TCP，控制连接与数据连接；TELNET和SSH，远程登录功能；SNMP，网络管理应用层协议

### 数据链路层

1. 共享介质型网络
    - 争用方式
    - 令牌传递，令牌+数据包发送，令牌+数据包沿令牌环到接收端，标记已接收，令牌+数据包沿令牌环到发送端，数据包丢弃，令牌向下传递

2. 非共享介质网络
每个站直连交换机，交换机转发数据帧。交换机的单点问题

3. 交换机根据MAC地址转发
交换机自学，物理端口对应主机MAC地址，自学生产转发表。存储转发，会校验错误帧；直接转发不会

4. 环路检测
生成树法，网桥会相互交换BPDU包，以某一网桥构造树根，每个端口设置权重，优先端口出现问题，绕行备用端口；源路由法，帧的发送者显式指出路由信息，网桥只需要根据路由信息转发

5. VLAN
避免硬件改造，通过交换机按照其端口区分网段

## IP

### 基础
- IP路由也叫做多跳路由，每个区间决定包在下一跳被转发的路径。一跳以主机或路由器为节点；一跳可以通过网桥后交换集线器相连，不会通过路由器或网关相连。
- IP面向无连接，简化和提速

### IP地址
- 32位，网络标识和主机标识，大部分以子网掩码区分，前为网络标识，后为主机标识
- 分类，主机标识全0表示对应IP地址不可知，全1常用作广播地址
    - A类，0开头，1-8为网络
    - B类，10开头，1-16为网络
    - C类，110开头，1-24为网络
    - D类，1110开头，1-32为网络 
- 广播地址，收到包后会分发到改网段上所有节点
- 多播使用D类地址，224.0.0.0到224.0.0.255，路由器不会转发；224.0.1.0到238.255.255.255，用于全球范围或网络协议；239.0.0.0到239.255.255.255，不能用于Internet
- 私有地址，10./8，172.16/12，192.168/16，与NAT技术结合解决IP地址分配问题
- 默认路由，路由表中0.0.0.0/0，找不到其他路由时使用
- 分片优化，路径MTU发现，路径上数据链路中最小MTU，最大传输单元。原理为不分片发送，遇到错误通过ICMP返回MTU值，UDP没有重发机制，IP层分片；TCP重发机制，IP层不分片，缓存MTU
- IPv6，128位，16比特一组，16进制表示，连续0使用::，但仅允许一次；64位网络标识，后64位主机标识；需要路径MTU发现，以1280字节为单位发送

### IP协议
- DNS，IPv4或者IPv6，域名查找IP地址，域名服务器
- ARP，IPv4，IP地址查找MAC地址，广播发送ARP请求包，目标IP地址主机返回MAC地址，源主机缓存
- RARP，MAC地址查找IP地址
- ICMP，IPv4，通知出错原因，诊断查询消息
- DHCP，IPv4或者IPv6，即插即用，自动设置IP地址，统一管理分配
- NAT，NAT-PT，本地网络中使用私有地址，连接互联网时使用全局IP地址
- IP隧道，网络层后追加网络层首部，例如IPv4首部后面时IPv6首部

### TCP

- 窗口控制：多个段，滑动窗口
- 重发控制：超时重发；3次未接收到，高速重发
- 流量控制：减少重发机制，发送端根据接收端的接收能力控制发送数据量。定期窗口探测，返回接收端接收能力
- 拥塞控制：通信一开始，从窗口从1段开始**指数增长**1、2、4。**重发**会设置**慢启动阈值**，为重发时的**一半**，之后超过慢启动阈值后，**线性**增长`1段字节数*1段字节数/拥塞窗口字节`。慢启动阈值**超时**重发时窗口降为**1**；快速重发时窗口将为**慢启动阈值+3**

### 应用层协议

- TELNET用于远程登陆，`telnet 主机名 TCP端口`。telnet客户端，到服务端的telnetd，再到服务端的Shell。常用端口TELNET 23；FTP 21；SMTP 25； HTTP 80；POP3 110。`ftp 主机名`同`telnet 主机名 21`
- SSH用于加密的远程登陆，例如邮件到SSH客户端为TCP通信，SSH客户端到SSH服务端为SSH加密的TCP通信，SSH服务端到POP3服务端为TCP通信
- SMTP发送邮件协议，MIME第6层拓展数据格式，但个人电脑不可能一直开机，POP接收邮件协议，提供POP服务器

